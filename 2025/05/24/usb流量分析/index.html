<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="theme-color" content="#1a1a1a"><meta name="msapplication-navbutton-color" content="#1a1a1a"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>学习日常</title><script>(function() {
  // 尽早应用暗色模式，防止闪烁
  var savedDarkMode = localStorage.getItem('darkMode') === 'true';
  if (savedDarkMode) {
    document.documentElement.classList.add('dark-mode');
  }
})();
</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Playfair+Display:wght@400;500;600;700&amp;family=Fira+Code:wght@400;500&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="icon" href="/null">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/tags.css">

<link rel="stylesheet" href="/css/categories.css">

<link rel="stylesheet" href="/css/categories-accordion.css">

<link rel="stylesheet" href="/css/highlight.css">

<link rel="stylesheet" href="/css/toc.css">

<link rel="stylesheet" href="/css/image-zoom.css">

<link rel="stylesheet" href="/css/share.css">

<link rel="stylesheet" href="/css/mobile-nav.css">

<link rel="stylesheet" href="/css/search.css">

<link rel="stylesheet" href="/css/scrollbar.css">

<link rel="stylesheet" href="/css/timeline.css">

<link rel="stylesheet" href="/css/animations.css">

<link rel="stylesheet" href="/css/ai-theme.css">

<link rel="stylesheet" href="/css/loading-animation.css">
<!-- 条件加载关于页面样式--><style>:root {
  --primary-color: #1a1a1a;
  --secondary-color: #666666;
  --accent-color: #ff6b6b;
  --background-color: #ffffff;
  --text-color: #333333;
  --overlay-color: rgba(0, 0, 0, 0.7);
  --tag-background-color: #ffffff;
  --card-background-color: #ffffff;
}
</style><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/qxchuckle/Post-Summary-AI/chuckle-post-ai.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="app"><header class="header navbar-bubble"><nav class="nav"><div class="nav-container"><div class="nav-logo"><a href="/"><span class="nav-title">学习日常</span></a></div><div class="nav-menu"><a class="nav-item" href="/">首页</a><a class="nav-item" href="/about/">关于</a><a class="nav-item" href="/archives/">归档</a><a class="nav-item" href="/categories/">分类</a><a class="nav-item" href="/tags/">标签</a><div class="nav-item has-submenu"><span class="nav-link">网站</span><div class="submenu"><a class="submenu-item" target="_blank" rel="noopener" href="https://example.com">示例网站</a></div></div><!-- 搜索按钮--><div class="search-toggle"><i class="fas fa-search"></i></div></div><div class="nav-toggle"><span></span><span></span><span></span></div></div></nav></header><div class="search-overlay"><div class="search-container"><div class="search-form"><input class="search-input" type="text" placeholder="搜索文章..."/><div class="search-close">×</div></div><div class="search-results"></div></div></div><main class="main"><div class="post-wrapper"><div class="toc-sidebar"><div class="toc-container"><div class="toc-title">目录</div><div class="toc-content" id="table-of-contents"><!-- Table of contents will be generated by JavaScript--></div></div></div><article class="post-container"><div class="post-header"><div class="post-cover"><img src="/images/2.jpg" alt="usb流量分析"/></div><div class="post-meta"><div class="post-category"><a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></div><div class="post-date"><time datetime="2025-05-23T16:00:00.000Z">五月 24, 2025</time></div><div class="post-author"><span>By 原</span></div></div><h1 class="post-title">usb流量分析</h1><div class="post-tags"><a class="tag" href="/tags/%E6%8A%80%E6%9C%AF/">技术</a></div></div><!-- AI摘要模块容器--><div id="post-ai-container"></div><div class="post-content"><h1 id="usb流量分析"><a href="#usb流量分析" class="headerlink" title="usb流量分析"></a>usb流量分析</h1><h3 id="USB-HID-协议的核心作用"><a href="#USB-HID-协议的核心作用" class="headerlink" title="USB HID 协议的核心作用"></a><strong>USB HID 协议的核心作用</strong></h3><p>USB HID（Human Interface Device）协议是 USB 协议体系中专门用于<strong>人机接口设备</strong>的通信协议，主要用于实现设备与主机之间的交互控制。它是 USB 协议的一个子类（Class），广泛应用于键盘、鼠标、游戏手柄、触摸板、数位板等设备。</p>
<h4 id="1-标准化人机交互通信"><a href="#1-标准化人机交互通信" class="headerlink" title="1. 标准化人机交互通信"></a>1. <strong>标准化人机交互通信</strong></h4><ul>
<li><strong>统一接口规范</strong>：为不同厂商的人机接口设备提供统一的通信标准，确保设备在 Windows、Linux、macOS 等系统中即插即用。</li>
<li><strong>简化开发流程</strong>：设备厂商无需自定义复杂协议，只需遵循 HID 规范即可实现基本功能（如键盘按键、鼠标移动）。</li>
</ul>
<h4 id="2-支持实时交互与低延迟"><a href="#2-支持实时交互与低延迟" class="headerlink" title="2. 支持实时交互与低延迟"></a>2. <strong>支持实时交互与低延迟</strong></h4><ul>
<li><strong>实时性要求高</strong>：HID 设备（如键盘、鼠标）需要实时反馈用户操作，HID 协议通过 ** 中断传输（Interrupt Transfer）** 机制保证数据传输的及时性，延迟通常低于 10ms。</li>
<li><strong>小数据量优化</strong>：针对按键状态、鼠标位移等小数据量场景设计，单次传输数据通常为 1~64 字节（典型为 8 字节或 32 字节）。</li>
</ul>
<h4 id="3-定义设备功能与报告格式"><a href="#3-定义设备功能与报告格式" class="headerlink" title="3. 定义设备功能与报告格式"></a>3. <strong>定义设备功能与报告格式</strong></h4><ul>
<li><p>HID 描述符（Descriptor）</p>
<p>通过设备描述符、配置描述符、报告描述符等定义设备功能。例如：</p>
<ul>
<li>键盘需声明 “按键报告” 的格式（如字节位代表按键状态）；</li>
<li>鼠标需声明 “X&#x2F;Y 轴位移”“按键状态” 等数据字段。</li>
</ul>
</li>
<li><p><strong>报告数据（Report Data）</strong>：<br>设备通过报告数据向主机传输状态（如按键按下、鼠标移动），主机也可通过报告数据向设备发送控制指令（如 LED 灯开关）。</p>
</li>
</ul>
<h3 id="USB-HID-协议的典型应用场景"><a href="#USB-HID-协议的典型应用场景" class="headerlink" title="USB HID 协议的典型应用场景"></a><strong>USB HID 协议的典型应用场景</strong></h3><table>
<thead>
<tr>
<th><strong>设备类型</strong></th>
<th><strong>核心功能</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>键盘</strong></td>
<td>传输按键扫描码（如 ASCII 映射、特殊按键组合），支持多键无冲。</td>
</tr>
<tr>
<td><strong>鼠标</strong></td>
<td>传输 X&#x2F;Y 轴相对位移、滚轮滚动量、左右中键状态，支持多按钮扩展（如侧键）。</td>
</tr>
<tr>
<td><strong>游戏手柄</strong></td>
<td>传输摇杆位置（模拟量）、扳机键压力值、按钮状态，支持力反馈（需厂商扩展）。</td>
</tr>
<tr>
<td><strong>触摸板 &#x2F; 数位板</strong></td>
<td>传输触点坐标、压力值、手势操作（如双指缩放）。</td>
</tr>
<tr>
<td><strong>工业控制设备</strong></td>
<td>传输自定义按钮状态（如数控机床操作面板）。</td>
</tr>
<tr>
<td><strong>生物识别设备</strong></td>
<td>传输指纹、心率等传感器数据（需符合 HID Usage Tables 扩展）。</td>
</tr>
</tbody></table>
<p>不同的设备类型的具体协议有所不同，主要体现在数据包的数据区的字节长度和不同字节的对应表示不同。</p>
<p>USB协议数据，在 leftover capture data 中。Leftover Capture Data在Wireshark中的作用是存储未被其他协议解析器识别或处理的数据包内容。‌</p>
<p> 具体来说，Leftover Capture Data模块主要用于存储USB设备（如鼠标、键盘等）的命令指令和数据。当Wireshark捕获到USB流量时，这些流量中的数据包内容可能会被存储在Leftover Capture Data中，特别是那些不符合标准协议规范的数据包。之后通过使用tshark工具，可以将这些数据提取出来进行进一步分析‌。</p>
<h4 id="1-鼠标流量分析"><a href="#1-鼠标流量分析" class="headerlink" title="1.鼠标流量分析"></a>1.鼠标流量分析</h4><p>在CTF中对鼠标流量一般是需要还原鼠标的经过轨迹，关键信息就在还原轨迹之中。由于不同鼠标使用的鼠标协议是不同的，每个数据包的数据区可能是4字节、6字节或者8字节。<br>数据报的数据区若是4字节时的含义如表9-3所示。<br>第一字节：按键。0x00为没有按键， 0x01为左键，0x02为右键。<br>第二字节：水平位移。为正（小于127）是向右移动多少像素，为负（负数补码，大于127小于255）是向左移动多少像素。<br>第三字节：垂直位置。为正（小于127）是向上移动多少像素，为负（负数补码，大于127小于255）是向下移动多少像素。<br>第四字节：滚轮数据。0，没有滚轮运动；1，垂直向上滚动一下；2，水平滚动右键一次；0xFE，水平滚动左键单击一下；0xFF，垂直向下滚动一下。</p>
<p>当数据区是6个字节时，第一个字节表示按键指示左右键， 第二个字节表示水平位移，第三个字节表示垂直位移。<br>数据区若是8个字节时，第一个字节表示按键指示左右键，第三个字节表示水平位移，第五个字节表示垂直位移。</p>
<h4 id="2-键盘流量分析"><a href="#2-键盘流量分析" class="headerlink" title="2.键盘流量分析"></a>2.键盘流量分析</h4><p>键盘数据包的数据长度为8个字节， **击键信息在第3个字节。**每次击键都会产生一个数据包。 <strong>如果我们拿到的流量包是USB协议，即数据报中Capture Data 的信息都是8个字节，几乎只有第3个字节不为00</strong>，下图很明显能看出来：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250521190550438.png" alt="image-20250521190550438"></p>
<h3 id="做题方法"><a href="#做题方法" class="headerlink" title="做题方法"></a>做题方法</h3><p>USB协议的数据部分在 Leftover Capture Data 域之中，可以用tshark命令将leftover capture data 数据单独提取出来，利用命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tshark -r 1.pcapng -T fields -e usb.capdata &gt; usbdata.txt</span><br><span class="line">tshark -r 1.pcapng -T fields -e usbhid.data &gt; usbdata.txt</span><br></pre></td></tr></table></figure>

<p>其中 -r 是读入文件， -w 是输出文件。</p>
<p>-T 是设置解码结果输出的格式，-T fields 指定输出为字段形式，后面可以跟多个字段名（如 frame.time、ip.src 等），用于提取特定信息。</p>
<p>最后输出为usbdata.txt。</p>
<p>然后编写一个键盘映射脚本Keyboard.py，针对提取出的usbdata.txt代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line">mappings = &#123;<span class="number">0x04</span>:<span class="string">&quot;A&quot;</span>,<span class="number">0x05</span>:<span class="string">&quot;B&quot;</span>,<span class="number">0x06</span>:<span class="string">&quot;C&quot;</span>,<span class="number">0x07</span>:<span class="string">&quot;D&quot;</span>,<span class="number">0x08</span>:<span class="string">&quot;E&quot;</span>,<span class="number">0x09</span>:<span class="string">&quot;F&quot;</span>,<span class="number">0x0a</span>:<span class="string">&quot;G&quot;</span>,<span class="number">0x0b</span>:<span class="string">&quot;H&quot;</span>,<span class="number">0x0c</span>:<span class="string">&quot;I&quot;</span>,<span class="number">0x0d</span>:<span class="string">&quot;J&quot;</span>,<span class="number">0x0e</span>:<span class="string">&quot;K&quot;</span>,<span class="number">0x0f</span>:<span class="string">&quot;L&quot;</span>,<span class="number">0x10</span>:<span class="string">&quot;M&quot;</span>,<span class="number">0x11</span>:<span class="string">&quot;N&quot;</span>,<span class="number">0x12</span>:<span class="string">&quot;O&quot;</span>,<span class="number">0x13</span>:<span class="string">&quot;P&quot;</span>,<span class="number">0x14</span>:<span class="string">&quot;Q&quot;</span>,<span class="number">0x15</span>:<span class="string">&quot;R&quot;</span>,<span class="number">0x16</span>:<span class="string">&quot;S&quot;</span>,<span class="number">0x17</span>:<span class="string">&quot;T&quot;</span>,<span class="number">0x18</span>:<span class="string">&quot;U&quot;</span>,<span class="number">0x19</span>:<span class="string">&quot;V&quot;</span>,<span class="number">0x1a</span>:<span class="string">&quot;W&quot;</span>,<span class="number">0x1b</span>:<span class="string">&quot;X&quot;</span>,<span class="number">0x1c</span>:<span class="string">&quot;Y&quot;</span>,<span class="number">0x1d</span>:<span class="string">&quot;Z&quot;</span>,<span class="number">0x1e</span>:<span class="string">&quot;!&quot;</span>,<span class="number">0x1f</span>:<span class="string">&quot;@&quot;</span>,<span class="number">0x20</span>:<span class="string">&quot;#&quot;</span>,<span class="number">0x21</span>:<span class="string">&quot;$&quot;</span>,<span class="number">0x22</span>:<span class="string">&quot;%&quot;</span>,<span class="number">0x23</span>:<span class="string">&quot;^&quot;</span>,<span class="number">0x24</span>:<span class="string">&quot;&amp;&quot;</span>,<span class="number">0x25</span>:<span class="string">&quot;*&quot;</span>,<span class="number">0x26</span>:<span class="string">&quot;(&quot;</span>,<span class="number">0x27</span>:<span class="string">&quot;)&quot;</span>,<span class="number">0x28</span>:<span class="string">&quot;&lt;RET&gt;&quot;</span>,<span class="number">0x29</span>:<span class="string">&quot;&lt;ESC&gt;&quot;</span>,<span class="number">0x2a</span>:<span class="string">&quot;&lt;DEL&gt;&quot;</span>,<span class="number">0x2b</span>:<span class="string">&quot;\t&quot;</span>,<span class="number">0x2c</span>:<span class="string">&quot;&lt;SPACE&gt;&quot;</span>,<span class="number">0x2d</span>:<span class="string">&quot;_&quot;</span>,<span class="number">0x2e</span>:<span class="string">&quot;+&quot;</span>,<span class="number">0x2f</span>:<span class="string">&quot;&#123;&quot;</span>,<span class="number">0x30</span>:<span class="string">&quot;&#125;&quot;</span>,<span class="number">0x31</span>:<span class="string">&quot;|&quot;</span>,<span class="number">0x32</span>:<span class="string">&quot;&lt;NON&gt;&quot;</span>,<span class="number">0x33</span>:<span class="string">&quot;\&quot;&quot;</span>,<span class="number">0x34</span>:<span class="string">&quot;:&quot;</span>,<span class="number">0x35</span>:<span class="string">&quot;&lt;GA&gt;&quot;</span>,<span class="number">0x36</span>:<span class="string">&quot;&lt;&quot;</span>,<span class="number">0x37</span>:<span class="string">&quot;&gt;&quot;</span>,<span class="number">0x38</span>:<span class="string">&quot;?&quot;</span>,<span class="number">0x39</span>:<span class="string">&quot;&lt;CAP&gt;&quot;</span>,<span class="number">0x3a</span>:<span class="string">&quot;&lt;F1&gt;&quot;</span>,<span class="number">0x3b</span>:<span class="string">&quot;&lt;F2&gt;&quot;</span>,<span class="number">0x3c</span>:<span class="string">&quot;&lt;F3&gt;&quot;</span>,<span class="number">0x3d</span>:<span class="string">&quot;&lt;F4&gt;&quot;</span>,<span class="number">0x3e</span>:<span class="string">&quot;&lt;F5&gt;&quot;</span>,<span class="number">0x3f</span>:<span class="string">&quot;&lt;F6&gt;&quot;</span>,<span class="number">0x40</span>:<span class="string">&quot;&lt;F7&quot;</span>,<span class="number">0x41</span>:<span class="string">&quot;&lt;F8&gt;&quot;</span>,<span class="number">0x42</span>:<span class="string">&quot;&lt;F9&gt;&quot;</span>,<span class="number">0x43</span>:<span class="string">&quot;&lt;F10&gt;&quot;</span>,<span class="number">0x44</span>:<span class="string">&quot;&lt;F11&gt;&quot;</span>,<span class="number">0x45</span>:<span class="string">&quot;&lt;F12&gt;&quot;</span>&#125;</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;usbdata.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="comment">#处理形如“0000120000000000”的内容</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(line) == <span class="number">16</span>:</span><br><span class="line">            s = <span class="built_in">int</span>(line[<span class="number">4</span>:<span class="number">6</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="comment">#处理形如“00:00:12:00:00:00:00”</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(line) ==<span class="number">24</span>:</span><br><span class="line">            s = <span class="built_in">int</span>(line[<span class="number">6</span>:<span class="number">8</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> s!=<span class="number">0</span>:</span><br><span class="line">            result += mappings[s]</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_usb_mouse_data</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    解析USB鼠标数据并提取左键点击的坐标</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    input_file (str): 包含USB鼠标数据的输入文件路径</span></span><br><span class="line"><span class="string">    output_file (str): 输出坐标的文件路径</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> keys, <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> result:</span><br><span class="line">            posx = <span class="number">0</span>  <span class="comment"># X轴累计位置</span></span><br><span class="line">            posy = <span class="number">0</span>  <span class="comment"># Y轴累计位置</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> line_num, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(keys, <span class="number">1</span>):</span><br><span class="line">                line = line.strip()  <span class="comment"># 去除行首尾的空白字符</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 处理类似 &quot;0000120000000000&quot; 的16字符格式数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(line) == <span class="number">16</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        x = <span class="built_in">int</span>(line[<span class="number">4</span>:<span class="number">6</span>], <span class="number">16</span>)  <span class="comment"># 提取X位移值（第5-6个字符）</span></span><br><span class="line">                        y = <span class="built_in">int</span>(line[<span class="number">8</span>:<span class="number">10</span>], <span class="number">16</span>) <span class="comment"># 提取Y位移值（第9-10个字符）</span></span><br><span class="line">                    <span class="keyword">except</span> ValueError:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;警告: 第<span class="subst">&#123;line_num&#125;</span>行的X/Y值格式错误: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 处理类似 &quot;00:00:12:00:00:00:00:00&quot; 的24字符格式数据</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">len</span>(line) == <span class="number">24</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        x = <span class="built_in">int</span>(line[<span class="number">6</span>:<span class="number">8</span>], <span class="number">16</span>)  <span class="comment"># 提取X位移值（第7-8个字符）</span></span><br><span class="line">                        y = <span class="built_in">int</span>(line[<span class="number">12</span>:<span class="number">14</span>], <span class="number">16</span>) <span class="comment"># 提取Y位移值（第13-14个字符）</span></span><br><span class="line">                    <span class="keyword">except</span> ValueError:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;警告: 第<span class="subst">&#123;line_num&#125;</span>行的X/Y值格式错误: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 跳过不符合预期格式的行</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;警告: 第<span class="subst">&#123;line_num&#125;</span>行格式不符合预期: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 处理有符号整数（将0-255的值转换为-128-127）</span></span><br><span class="line">                <span class="keyword">if</span> x &gt; <span class="number">127</span>:</span><br><span class="line">                    x -= <span class="number">256</span></span><br><span class="line">                <span class="keyword">if</span> y &gt; <span class="number">127</span>:</span><br><span class="line">                    y -= <span class="number">256</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 更新累计位置</span></span><br><span class="line">                posx += x</span><br><span class="line">                posy += y</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 提取按钮状态（前两个字符）</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    btn_flag = <span class="built_in">int</span>(line[<span class="number">0</span>:<span class="number">2</span>], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">except</span> ValueError:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;警告: 第<span class="subst">&#123;line_num&#125;</span>行的按钮状态格式错误: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检测左键点击（值为1）</span></span><br><span class="line">                <span class="keyword">if</span> btn_flag == <span class="number">1</span>:</span><br><span class="line">                    result.write(<span class="string">f&quot;<span class="subst">&#123;posx&#125;</span> <span class="subst">&#123;-posy&#125;</span>\n&quot;</span>)  <span class="comment"># 写入X和负Y坐标（Y轴方向可能需要调整）</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 文件 <span class="subst">&#123;input_file&#125;</span> 不存在&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 处理文件时发生异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 默认文件名</span></span><br><span class="line">    input_file = <span class="string">&#x27;usbdata.txt&#x27;</span></span><br><span class="line">    output_file = <span class="string">&#x27;1.txt&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 可选：从命令行参数获取文件名</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        input_file = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">2</span>:</span><br><span class="line">        output_file = sys.argv[<span class="number">2</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在解析 <span class="subst">&#123;input_file&#125;</span>...&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> parse_usb_mouse_data(input_file, output_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;解析完成，结果已保存到 <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;解析过程中发生错误&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="ctf中的应用"><a href="#ctf中的应用" class="headerlink" title="ctf中的应用"></a>ctf中的应用</h3><p>通过捕获 USB 键盘通信的 HID 报告数据，解析其中的按键扫描码（如 USB HID 键盘的键码表），还原输入的 Flag。</p>
<h3 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h3><h4 id="第九章-9-4-3-案例解析-NISACTF-2022-破损的flag"><a href="#第九章-9-4-3-案例解析-NISACTF-2022-破损的flag" class="headerlink" title="[第九章][9.4.3 案例解析][NISACTF 2022]破损的flag"></a><code>[第九章][9.4.3 案例解析][NISACTF 2022]破损的flag</code></h4><p>在kali中通过<code>file</code>命令可得出是pcap流量包数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250521192946801.png" alt="image-20250521192946801"></p>
<p>将后缀改为pcapng</p>
<p>使用命令提取出其中的Leftover Capture Data 信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r 1.pcapng -T fields -e usb.capdata &gt; usbdata.txt</span><br></pre></td></tr></table></figure>

<p>可以用前文的 <strong>键盘映射脚本</strong>进行提取，得到信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250521193427961.png" alt="image-20250521193427961"></p>
<p>推测出来是键盘密码，在键盘密码中寻找被包围起来的字母，如下所示：<br>UJKO：i<br>POK:：l<br>QWSZ：a<br>QASE：w<br>IKLP：O<br>RDCVG：f<br>NJK&lt;：m<br>RDCVG：f<br>TFVBH：g<br>WSDR：e<br>NJK：m<br>UHNMK：j<br>TFVBH：g<br>RDCVG：f<br>UJKO：i<br>POK:：l<br>WSDR：e<br>BHJM：n<br>YHJI：u<br>POK：l<br>WAZXD：s<br>XDFV：c<br>RFGY：t<br>YHJI：u</p>
<p>把这段代码解密后就是：<br>imgulfflagiswelcometfjnu<br>按单词分隔：im gulf flag is welcome t fjnu</p>
<p>guif可能是guess；</p>
<p>flag可能是flag{welcome_to_fjnu} 或 flag{welcome_t_fjnu}；</p>
<p>尝试一下是第一个</p>
<h4 id="buuctf——usb"><a href="#buuctf——usb" class="headerlink" title="buuctf——usb"></a><code>buuctf——usb</code></h4><p>下载附件之后可以看到有两个文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522171741007.png" alt="image-20250522171741007"></p>
<p>不知到key.ftm是什么文件</p>
<p>binwalk看看有没有隐藏文件，发现有</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522173246027.png"></p>
<p>然后使用foremost提取出文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522173310031.png" alt="image-20250522173310031"></p>
<p>打开之后发现是两份zip文件；但是查看后发现是和原本文件里的是一样的，都是一个USB流量包</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522173553180.png" alt="image-20250522173553180"></p>
<p>让后按照之前的方法；先把leftover capture data 数据单独提取出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r 1.pcapng -T fields -e usb.capdata &gt; usbdata.txt</span><br></pre></td></tr></table></figure>

<p>然后运行一下脚本</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522174055698.png" alt="image-20250522174055698"></p>
<p>看到这里有一个key；可能是带key解密</p>
<p>然后看233.rar</p>
<p>将233.rar放进kali中使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unrar l 233.rar</span><br></pre></td></tr></table></figure>

<p>查看文件内容</p>
<p>这里不要直接放进nanazip里查看。</p>
<p>放进010里可以看到233.png的rar压缩格式的文件头有问题，文件块的HEAD_TYPE应该是0x74而不是0x7A，这会导致直接放进nanzip会看不到233.png这个图片</p>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/8f68d59419fd307cf4c0377f3cccd2d1.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522172157958.png" alt="image-20250522172157958"></p>
<p>然后使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unrar x 233.rar</span><br></pre></td></tr></table></figure>

<p>进行解压</p>
<p>也可以在010里修改文件头再解压</p>
<p>发现里面有233.png和flag.txt；打开flag.txt发现里面什么也没有</p>
<p>将233.png放进stegsolve之中，发现一个二维码</p>
<p><img src="E:\edge\image-20250522172654787.png" alt="image-20250522172654787"></p>
<p>扫一下</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522172955234.png" alt="image-20250522172955234"></p>
<p>结合之前的key尝试解密</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522174908770.png" alt="image-20250522174908770"></p>
<p>从维吉尼亚密码尝试，结果很像flag再次放进随波逐流里得到flag。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zzy20060723/image/image-20250522201947742.png" alt="image-20250522201947742"></p>
</div><!-- 初始化AI摘要--><script>document.addEventListener('DOMContentLoaded', function() {
  if (typeof ChucklePostAI !== 'undefined') {
    // 获取按钮文本，如果未定义则使用默认值
    const buttons = [
      "介绍自己",
      "来点灵感",
      "生成AI简介"
    ];

    new ChucklePostAI({
      el: '#post-ai-container',
      title_el: '.post-title',
      summary_directly: false,
      interface: {
        name: "然-AI",
        introduce: "我是文章辅助AI: 然-AI，一个基于deepseek的强大语言模型，有什么可以帮到您？😊",
        version: "deepseekv3",
        button: buttons
      }
    });
  }
});
</script><!-- 传递TOC配置给前端--><script>// 创建全局TOC配置对象
window.tocConfig = {
  empty_toc_behavior: "placeholder"
};
</script><div class="post-navigation"><div class="post-nav prev"><a href="/2025/07/14/picoCTF-2023/"><span class="nav-label">← Previous</span><span class="nav-title">picoCTF-2023</span></a></div><div class="post-nav next"><a href="/2025/05/11/%E5%9B%BE%E7%89%87/"><span class="nav-label">Next →</span><span class="nav-title">图片</span></a></div></div><div class="post-share"><h3 class="share-title">Share this article</h3><div class="share-buttons"><a class="share-btn twitter" href="https://twitter.com/intent/tweet?text=usb%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90&amp;url=%2F2025%2F05%2F24%2Fusb%25E6%25B5%2581%25E9%2587%258F%25E5%2588%2586%25E6%259E%2590%2F" target="_blank" rel="noopener"><span>Twitter</span></a><a class="share-btn facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2F2025%2F05%2F24%2Fusb%25E6%25B5%2581%25E9%2587%258F%25E5%2588%2586%25E6%259E%2590%2F" target="_blank" rel="noopener"><span>Facebook</span></a><a class="share-btn linkedin" href="https://www.linkedin.com/sharing/share-offsite/?url=%2F2025%2F05%2F24%2Fusb%25E6%25B5%2581%25E9%2587%258F%25E5%2588%2586%25E6%259E%2590%2F" target="_blank" rel="noopener"><span>LinkedIn</span></a><a class="share-btn wechat" href="#" data-wechat="/2025/05/24/usb%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"><span>微信</span></a><a class="share-btn qq" href="https://connect.qq.com/widget/shareqq/index.html?url=%2F2025%2F05%2F24%2Fusb%25E6%25B5%2581%25E9%2587%258F%25E5%2588%2586%25E6%259E%2590%2F&amp;title=usb%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90" target="_blank" rel="noopener"><span>QQ</span></a><a class="share-btn weibo" href="https://service.weibo.com/share/share.php?url=%2F2025%2F05%2F24%2Fusb%25E6%25B5%2581%25E9%2587%258F%25E5%2588%2586%25E6%259E%2590%2F&amp;title=usb%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90" target="_blank" rel="noopener"><span>微博</span></a><a class="share-btn copy" href="#" data-copy="/2025/05/24/usb%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"><span>Copy Link</span></a></div></div></article></div></main><footer class="footer"><div class="footer-bottom"><div class="footer-copyright">© 2025 李思然. All rights reserved.</div><!-- Footer centered image with link--><div class="footer-image" style="text-align: center; margin: 15px 0;"><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank" rel="noopener noreferrer"><img src="https://s21.ax1x.com/2024/08/23/pAFm0cq.png" alt="Footer Image" style="max-width: 100%; height: auto;"/></a></div><div class="footer-badges"><a target="_blank" rel="noopener" href="https://hexo.io/" title="博客框架为Hexo_v5.4.0"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="本站已在粤网管局备案"><img src="https://img.shields.io/badge/粤ICP备-2022157092号-yellow.svg?logo=data:image/png;base64,UklGRjgCAABXRUJQVlA4WAoAAAAQAAAAEwAAEwAAQUxQSJgAAAABgKpt//nn+RvZ89KuNVcbR6C6pBNYW12zl61oO23Vtu2/v59TiIgJILircnOrKgLlzL4Pj8fj+RkuUTB7FE0hIuZVxs1B4r88yudxAakeYQIQsSiZiYVaj7ge2mS9cCbbgTfZIYzJmmFVtgQ/slsolaUB5Y9qtzkAmRdqN0EmPMKBAGvjq8pRnTYAbBVdK9unpytTDQVaAFZQOCB6AQAAEAgAnQEqFAAUAD6RQJhJpaOiISgKqLASCWwAnTKEeZ+Z8UG4b3S8Uuxj0APK49jD9jvRsJlHSAAk4peJdT29v1IEVadPwR6oAAD+BVzylNKb2DP80JoQLtKM1HYe/A2NwP2FBXtSNypNu+PttP+EadMJsrmm/ULTvb6jEqpziSt//sRMcbrAVYftaY1KNWWudr1AdlUv5D5HRoEfwcV0Pu9dhsXZ3ojpXwjGWWBJfv4puUOV9aczt7uvE8SHYSo33C18yNeqL9sZ211bKOY/rjT8Wzi9Wg+hj7Xvi/3NC1proBfzmpWysW6y3/63VcYMlVBx6v5o9WNvzL1XLvbR7wTooDXtSEjt6rJoaazbMoXie0mzg0G+evKLZ8vz/yKv/u4RDK0EF+ejNfOOU0ZhepG6b/Ewbk1BofcYZC8JB4a2NPUtwhHtqE3tVT8PlHEvlf+xYFbG7Wms4JVHiSMfc36K5LOwcwC89RYMLn0jFD1wQF2/QrJAAAAA" alt="本站已在粤网管局备案"/></a><a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></div></div></footer></div><!-- 立即应用暗色模式，避免页面闪烁--><script>(function() {
  // 检查本地存储中的暗色模式设置
  const savedDarkMode = localStorage.getItem('darkMode') === 'true';
  // 如果设置为暗色模式，立即应用到body
  if (savedDarkMode) {
    document.body.classList.add('dark-mode');
  }

  // 防止页面闪烁，在DOM加载完成前设置一个初始类
  document.documentElement.style.visibility = 'hidden';
  document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.style.visibility = 'visible';
  });
})();
</script>
<script src="/js/main.js"></script>

<script src="/js/tags.js"></script>

<script src="/js/categories-accordion.js"></script>

<script src="/js/highlight.js"></script>

<script src="/js/load-more.js"></script>

<script src="/js/header-scroll.js"></script>

<script src="/js/toc.js"></script>

<script src="/js/image-zoom.js"></script>

<script src="/js/share.js"></script>

<script src="/js/search.js"></script>

<script src="/js/hide-inline-interaction.js"></script>

<script src="/js/hide-toggle-interaction.js"></script>

<script src="/js/dark-mode-sync.js"></script>

<script src="/js/animations.js"></script>

<script src="/js/ai-theme.js"></script>

<script src="/js/loading-animation.js"></script>
<script>window.theme = {
  features: {"dark_mode":true,"smooth_scroll":true,"back_to_top":true,"loading_animation":true},
  code_block: {"height_limit":200,"enable_folding":true,"max_height":"300px","show_lang":true},
  ai_summary: {"enable":true,"api_key":"","summary_directly":false,"ai_name":"然-AI","ai_introduce":"我是文章辅助AI: 然-AI，一个基于deepseek的强大语言模型，有什么可以帮到您？😊","ai_version":"deepseekv3","buttons":["介绍自己","来点灵感","生成AI简介"]},
  categories: {"layout":"accordion","accordion_animation":true,"show_empty_categories":true}
};
</script><script src="/js/ai.js"></script><script src="/js/postai.js"></script></body></html>